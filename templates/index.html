<!DOCTYPE html>
<html>
<head>
    <title>LLM Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .panel { flex: 1; min-width: 300px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        #metrics-chart { height: 300px; }
        #conversation { height: 400px; overflow-y: auto; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .user { background-color: #e3f2fd; }
        .llm { background-color: #f1f8e9; }
        textarea { width: 100%; min-height: 100px; }
    </style>
</head>
<body>
    <h1>LLM Monitoring Dashboard</h1>
    
    <div class="container">
        <div class="panel">
            <h2>System Metrics</h2>
            <canvas id="metrics-chart"></canvas>
            <div id="current-metrics">
                <p>CPU: <span id="cpu-value">0</span>%</p>
                <p>Memory: <span id="mem-value">0</span>%</p>
            </div>
        </div>
        
        <div class="panel">
            <h2>Conversation</h2>
            <div id="conversation"></div>
            <textarea id="prompt-input" placeholder="Enter your prompt..."></textarea>
            <button onclick="sendPrompt()">Send</button>
        </div>
    </div>

    <script>
        const socket = io();
        const conversationDiv = document.getElementById('conversation');
        const cpuValue = document.getElementById('cpu-value');
        const memValue = document.getElementById('mem-value');
        let chart;
        
        // Инициализация графиков
        function initChart(data) {
            const ctx = document.getElementById('metrics-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.history.timestamps,
                    datasets: [
                        {
                            label: 'CPU Usage (%)',
                            data: data.history.cpu,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1
                        },
                        {
                            label: 'Memory Usage (%)',
                            data: data.history.memory,
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { min: 0, max: 100 }
                    }
                }
            });
        }
        
        // Обработчики WebSocket
        socket.on('init', function(data) {
            // Загрузка истории разговора
            data.conversation.forEach(msg => {
                addMessage(msg.role, msg.content);
            });
            
            // Инициализация графика
            initChart({
                history: {
                    timestamps: Array(30).fill(''),
                    cpu: Array(30).fill(0),
                    memory: Array(30).fill(0)
                }
            });
        });
        
        socket.on('system_metrics', function(data) {
            cpuValue.textContent = data.cpu.toFixed(1);
            memValue.textContent = data.memory.toFixed(1);
            
            if (chart) {
                chart.data.labels = data.history.timestamps;
                chart.data.datasets[0].data = data.history.cpu;
                chart.data.datasets[1].data = data.history.memory;
                chart.update();
            }
        });
        
        socket.on('conversation_update', function(data) {
            addMessage(data.role, data.content);
        });
        
        socket.on('llm_output', function(data) {
            addMessage('llm', data.text, true);
        });
        
        function addMessage(role, content, append = false) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<strong>${role}:</strong> ${content}`;
            
            if (append && conversationDiv.lastChild && conversationDiv.lastChild.className.includes('llm')) {
                conversationDiv.lastChild.innerHTML += ` ${content}`;
            } else {
                conversationDiv.appendChild(div);
            }
            
            conversationDiv.scrollTop = conversationDiv.scrollHeight;
        }
        
        function sendPrompt() {
            const prompt = document.getElementById('prompt-input').value;
            if (prompt.trim()) {
                fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                document.getElementById('prompt-input').value = '';
            }
        }
    </script>
</body>
</html>